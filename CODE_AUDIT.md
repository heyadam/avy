# Code Audit Report

**Auditor**: Senior SWE Review
**Date**: 2025-12-19
**Codebase**: Composer - AI Workflow Builder

---

## Executive Summary

This codebase has **critical security vulnerabilities** that must be addressed before production deployment. The most severe issues involve unsafe code execution patterns and inadequate sandboxing that could lead to XSS attacks and arbitrary code execution.

**Overall Risk Level**: üî¥ **HIGH**

---

## üî¥ Critical Issues (Must Fix Before Production)

### 1. Insufficient Code Sandboxing in Magic Node

**Location**: `app/api/execute/route.ts:460-594` and `lib/execution/engine.ts:374-396`

**Problem**: The `magic-generate` feature uses regex-based pattern blocking followed by `new Function()` to execute AI-generated JavaScript. This approach is fundamentally insecure.

**Current "defense"**:
```typescript
const forbiddenPatterns = [
  /\beval\b/i,
  /\bFunction\b/,
  /\bwindow\b/,
  // ...more regex patterns
];
```

**Why it fails**:
1. **Regex bypass via encoding**: `\u0065val` or `\x65val` evaluates to `eval`
2. **Bracket notation bypass**: `this["constru"+"ctor"]["constru"+"ctor"]("alert(1)")()`
3. **Template literal bypass**: `` `${`e`}${'v'}${'a'}${'l'}` ``
4. **No runtime isolation**: `new Function()` runs in the same context with full access

**Impact**: Arbitrary code execution on the server and client. An attacker could:
- Steal API keys from the context
- Make unauthorized API calls
- Exfiltrate data

**Recommendation**: Use a proper sandbox like:
- `isolated-vm` (Node.js isolates)
- `vm2` with security hardening
- Web Workers with `blob:` URLs and restricted CSP
- Or remove this feature entirely

---

### 2. React Preview Iframe Sandbox Misconfiguration

**Location**: `components/Flow/ResponsesSidebar/ReactPreview.tsx:243`

**Problem**: The sandbox attribute uses `allow-same-origin`:
```tsx
sandbox="allow-scripts allow-same-origin"
```

**Why it's dangerous**: When `allow-scripts` and `allow-same-origin` are combined, the sandboxed iframe can:
- Access `parent.document` and the parent page's DOM
- Read/write localStorage (stealing API keys)
- Make authenticated requests on behalf of the user
- Completely defeat the purpose of sandboxing

**Current code renders AI-generated React with `new Function()`**:
```javascript
const executeCode = new Function(
  'React', 'useState', 'useEffect', // ...
  transformedCode + '; return Component;'
);
```

**Impact**: Any malicious component generated by the AI (or injected via prompt injection) can execute arbitrary code with full access to the parent page.

**Recommendation**:
- Remove `allow-same-origin` from sandbox
- Host the preview on a separate origin (e.g., `preview.composer.design`)
- Communicate via `postMessage` with strict origin validation

---

### 3. Unencrypted API Keys in localStorage

**Location**: `lib/api-keys/storage.ts:15-18`

**Problem**: Sensitive API keys are stored in plaintext:
```typescript
export function saveApiKeys(keys: ApiKeys): void {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(keys));
}
```

**Impact**: If any XSS vulnerability exists (see issues #1 and #2), attackers can trivially steal all stored API keys with:
```javascript
JSON.parse(localStorage.getItem('avy-api-keys'))
```

**Recommendation**:
- Encrypt keys before storage using Web Crypto API
- Use session-only storage (sessionStorage) with short TTL
- For production: store keys server-side with secure session tokens
- Implement key scoping/rotation

---

## üü† High Priority Issues

### 4. Zero Test Coverage

**Finding**: No test files exist in the codebase (`**/*.test.{ts,tsx}` returns empty)

**Impact**:
- No regression protection
- Cannot safely refactor security-critical code
- No validation of edge cases in execution engine

**Recommendation**: Add tests for:
- Flow execution engine (especially parallel branch handling)
- Magic code generation and validation
- API key storage/retrieval
- Input sanitization

---

### 5. Monolithic API Route (God Object)

**Location**: `app/api/execute/route.ts` (604 lines)

**Problem**: Single route handles 4 different operation types:
- `text-generation`
- `image-generation`
- `react-component`
- `magic-generate`

**Impact**:
- Difficult to test in isolation
- Single point of failure
- Hard to apply operation-specific security policies

**Recommendation**: Split into separate routes:
```
app/api/execute/
‚îú‚îÄ‚îÄ text/route.ts
‚îú‚îÄ‚îÄ image/route.ts
‚îú‚îÄ‚îÄ react/route.ts
‚îî‚îÄ‚îÄ magic/route.ts
```

---

### 6. No Request Body Size Limits

**Location**: `app/api/execute/route.ts:40`

**Problem**: No validation of request body size, especially for image data:
```typescript
const body = await request.json();
```

**Impact**:
- DoS via large payloads
- Memory exhaustion
- Potential for billion-laughs-style attacks

**Recommendation**: Add size limits in middleware or route config:
```typescript
export const config = {
  api: { bodyParser: { sizeLimit: '10mb' } }
};
```

---

### 7. Complex Execution Engine

**Location**: `lib/execution/engine.ts` (705 lines)

**Problem**: Complex state management with multiple tracking structures:
```typescript
const executedOutputs: Record<string, string> = {};
const executedNodes = new Set<string>();
const executingNodes = new Set<string>();
const nodePromises: Record<string, Promise<void>> = {};
```

**Impact**:
- Hard to reason about race conditions
- Difficult to debug execution order
- Potential for deadlocks in cyclic graphs

**Recommendation**:
- Extract state into a dedicated `ExecutionContext` class
- Add cycle detection before execution
- Implement proper state machine patterns

---

## üü° Medium Priority Issues

### 8. Minimal ESLint Configuration

**Location**: `eslint.config.mjs`

**Current config**: Only uses Next.js defaults with no custom rules.

**Missing rules**:
- `@typescript-eslint/no-explicit-any` - 3 instances found
- `complexity` - no limit on function complexity
- Unused variable detection beyond TypeScript
- Import ordering

---

### 9. Type Assertions Without Validation

**Examples**:
```typescript
// engine.ts:338
const item = event.item as any;

// route.ts:299
const imageGenTool: any = { ... };
```

**Recommendation**: Use type guards or Zod schemas for runtime validation.

---

### 10. Error Messages May Leak Internal Details

**Location**: Multiple API routes

**Example**:
```typescript
return NextResponse.json({ error: "No image generated", debug: result }, { status: 500 });
```

**Impact**: The `debug` field may expose internal state to attackers.

**Recommendation**: Only include debug info in development:
```typescript
const response = { error: "No image generated" };
if (process.env.NODE_ENV === 'development') {
  response.debug = result;
}
```

---

## üîµ Low Priority (Code Quality)

### 11. Global ID Counter
**Location**: `components/Flow/AgentFlow.tsx:47-60`

Uses `let id = 0` global variable. Should use `nanoid()` (already in deps).

### 12. Magic Strings
Model names like `gpt-5.2`, `claude-haiku-4-5` are hardcoded in multiple places instead of referencing `providers.ts`.

### 13. Missing JSDoc
Complex functions like `executeNodeAndContinue` lack documentation for the graph traversal algorithm.

---

## Security Checklist

| Category | Status | Notes |
|----------|--------|-------|
| Code Execution Sandbox | ‚ùå Fail | Regex bypass possible |
| Iframe Sandbox | ‚ùå Fail | `allow-same-origin` defeats sandbox |
| Secret Storage | ‚ùå Fail | Plaintext localStorage |
| Input Validation | ‚ö†Ô∏è Partial | Missing size limits |
| Error Handling | ‚ö†Ô∏è Partial | Debug info leaked |
| CSRF Protection | ‚úÖ Pass | Next.js handles this |
| XSS Protection | ‚ö†Ô∏è Risk | Via code execution flaws |
| Dependency Security | ‚úÖ Pass | Using official SDKs |

---

## Recommended Prioritization

### Immediate (Block deployment)
1. Fix iframe sandbox configuration
2. Implement proper code sandboxing or disable magic node
3. Add request body size limits

### Short-term (Within 1-2 weeks)
4. Encrypt API keys or move to server-side sessions
5. Add critical path unit tests
6. Split monolithic API route

### Medium-term (Backlog)
7. Refactor execution engine
8. Enhance ESLint configuration
9. Add comprehensive error handling

---

## Conclusion

The codebase demonstrates good architectural patterns (React Flow integration, streaming API responses, proper TypeScript usage) but has critical security gaps in code execution and sandboxing. **Do not deploy to production** until issues #1-3 are resolved.

The combination of unsafe `new Function()` usage with inadequate iframe sandboxing creates a severe vulnerability chain where AI-generated code could access and exfiltrate user API keys.
